{% extends 'base/base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Modifier Devis{% else %}Nouveau Devis{% endif %} - ETRAGC{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>
                        {% if form.instance.pk %}Modifier le Devis{% else %}Nouveau Devis{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" id="devisForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.client.id_for_label }}" class="form-label">Client *</label>
                                {{ form.client }}
                                {% if form.client.errors %}
                                    <div class="text-danger">{{ form.client.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.projet.id_for_label }}" class="form-label">Projet</label>
                                {{ form.projet }}
                                {% if form.projet.errors %}
                                    <div class="text-danger">{{ form.projet.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.date_emission.id_for_label }}" class="form-label">Date d'émission *</label>
                                {{ form.date_emission }}
                                {% if form.date_emission.errors %}
                                    <div class="text-danger">{{ form.date_emission.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.date_validite.id_for_label }}" class="form-label">Date de validité *</label>
                                {{ form.date_validite }}
                                {% if form.date_validite.errors %}
                                    <div class="text-danger">{{ form.date_validite.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.montant_ht.id_for_label }}" class="form-label">Montant HT (GNF) *</label>
                                {{ form.montant_ht }}
                                {% if form.montant_ht.errors %}
                                    <div class="text-danger">{{ form.montant_ht.errors }}</div>
                                {% endif %}
                                <small class="text-muted">Calculé automatiquement à partir des lignes</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.conditions_paiement.id_for_label }}" class="form-label">Conditions de paiement</label>
                                {{ form.conditions_paiement }}
                                {% if form.conditions_paiement.errors %}
                                    <div class="text-danger">{{ form.conditions_paiement.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="text-danger">{{ form.notes.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Lignes du devis</h5>
                            <button type="button" class="btn btn-success btn-sm" id="add-ligne-btn">
                                <i class="fas fa-plus me-1"></i>Ajouter une ligne
                            </button>
                        </div>
                        
                        {{ formset.management_form }}
                        <div id="lignes-container">
                            {% for form in formset %}
                                <div class="ligne-devis border rounded p-3 mb-3">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <label class="form-label">Description</label>
                                            {{ form.description }}
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Quantité</label>
                                            {{ form.quantite }}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Prix unitaire</label>
                                            {{ form.prix_unitaire_ht }}
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-danger btn-sm delete-ligne-btn">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <div class="d-none">
                                                {{ form.DELETE }}
                                            </div>
                                        </div>
                                    </div>
                                    {{ form.id }}
                                </div>
                            {% endfor %}
                        </div>
                        
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Enregistrer
                            </button>
                            <a href="{% url 'invoicing:devis_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fonction pour calculer le montant total HT du devis
function calculerMontantTotal() {
    let total = 0;
    
    // Parcourir toutes les lignes de devis
    document.querySelectorAll('.ligne-devis').forEach(function(ligne) {
        // Vérifier si la ligne n'est pas marquée pour suppression
        const deleteCheckbox = ligne.querySelector('input[type="checkbox"][name$="-DELETE"]');
        if (deleteCheckbox && deleteCheckbox.checked) {
            return; // Ignorer cette ligne
        }
        
        // Récupérer la quantité et le prix unitaire
        const quantiteInput = ligne.querySelector('input[name$="-quantite"]');
        const prixInput = ligne.querySelector('input[name$="-prix_unitaire_ht"]');
        
        if (quantiteInput && prixInput) {
            const quantite = parseFloat(quantiteInput.value) || 0;
            const prix = parseFloat(prixInput.value) || 0;
            total += quantite * prix;
        }
    });
    
    // Mettre à jour le champ montant HT
    const montantHtInput = document.getElementById('montant_ht_devis');
    if (montantHtInput) {
        montantHtInput.value = total.toFixed(2);
    }
}

// Fonction pour attacher les événements à une ligne
function attacherEvenementsLigne(ligne) {
    // Événements pour les champs de quantité et prix
    ligne.querySelectorAll('input[name$="-quantite"], input[name$="-prix_unitaire_ht"]').forEach(function(input) {
        input.addEventListener('input', calculerMontantTotal);
        input.addEventListener('change', calculerMontantTotal);
    });
    
    // Événement pour le bouton de suppression
    const deleteBtn = ligne.querySelector('.delete-ligne-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            const deleteCheckbox = ligne.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                ligne.style.display = 'none';
                calculerMontantTotal();
            }
        });
    }
}

// Fonction pour ajouter une nouvelle ligne
function ajouterNouvelleLigne() {
    const lignesContainer = document.getElementById('lignes-container');
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    const formNum = parseInt(totalFormsInput.value);
    
    // Récupérer le template de la première ligne
    const premiereLigne = document.querySelector('.ligne-devis');
    if (!premiereLigne) return;
    
    // Cloner la première ligne
    const nouvelleLigne = premiereLigne.cloneNode(true);
    
    // Mettre à jour les attributs name et id avec le nouveau numéro de formulaire
    nouvelleLigne.querySelectorAll('input, select, textarea').forEach(function(input) {
        if (input.name) {
            input.name = input.name.replace(/-\d+-/, `-${formNum}-`);
        }
        if (input.id) {
            input.id = input.id.replace(/-\d+-/, `-${formNum}-`);
        }
        // Réinitialiser les valeurs sauf pour DELETE
        if (!input.name.includes('DELETE') && !input.name.includes('id')) {
            input.value = '';
        }
        // Décocher la case DELETE
        if (input.type === 'checkbox' && input.name.includes('DELETE')) {
            input.checked = false;
        }
    });
    
    // Afficher la ligne
    nouvelleLigne.style.display = '';
    
    // Ajouter la nouvelle ligne au conteneur
    lignesContainer.appendChild(nouvelleLigne);
    
    // Incrémenter le compteur de formulaires
    totalFormsInput.value = formNum + 1;
    
    // Attacher les événements à la nouvelle ligne
    attacherEvenementsLigne(nouvelleLigne);
    
    // Recalculer le montant
    calculerMontantTotal();
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Attacher les événements aux lignes existantes
    document.querySelectorAll('.ligne-devis').forEach(function(ligne) {
        attacherEvenementsLigne(ligne);
    });
    
    // Événement pour le bouton d'ajout de ligne
    const addBtn = document.getElementById('add-ligne-btn');
    if (addBtn) {
        addBtn.addEventListener('click', ajouterNouvelleLigne);
    }
    
    // Calculer le montant initial
    calculerMontantTotal();
});
</script>
{% endblock %}
